{{ define "main" }}
<section class="container mx-auto py-10">
    <h2 class="text-2xl font-bold mb-4">Signaler un point noir</h2>
    <p>Cliquer sur la carte afin de pointer le lieu du point de signalement.</p>

    <button id="locate" class="bg-blue-500 text-white px-4 py-2 rounded mt-2 mb-2">Utiliser ma localisation</button>
    
    <section class="min-h-[400px]">
        <div id="map_signalement" class="mt-4 rounded border min-h-auto"></div>
    </section>

    <form class="mt-4" method="POST" action="/submit-form">
        <label for="name" class="block font-semibold">Name:</label>
        <input type="text" id="name" name="name" class="w-full border p-2 rounded mb-2" required>

        <label for="email" class="block font-semibold">Email:</label>
        <input type="email" id="email" name="email" class="w-full border p-2 rounded mb-2" required>

        <label for="coords" class="block font-semibold">Coordinates:</label>
        <input type="text" id="coords" name="coords" class="w-full border p-2 rounded mb-2" readonly required>

        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Envoyer</button>
    </form>
</section>

<script>
    var map = L.map('map_signalement').setView([-22.2758, 166.458], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    var marker;

    function updateCoordinates(lat, lng) {
        document.getElementById('coords').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }

    map.on('click', function(e) {
        if (marker) {
            marker.setLatLng(e.latlng);
        } else {
            marker = L.marker(e.latlng, { draggable: true }).addTo(map);
            marker.on('dragend', function(event) {
                var position = event.target.getLatLng();
                updateCoordinates(position.lat, position.lng);
            });
        }
        updateCoordinates(e.latlng.lat, e.latlng.lng);
    });

    document.getElementById('locate').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                
                if (marker) {
                    marker.setLatLng([lat, lng]);
                } else {
                    marker = L.marker([lat, lng], { draggable: true }).addTo(map);
                    marker.on('dragend', function(event) {
                        var position = event.target.getLatLng();
                        updateCoordinates(position.lat, position.lng);
                    });
                }
                map.setView([lat, lng], 13);
                updateCoordinates(lat, lng);
            }, function(error) {
                alert('Geolocation failed: ' + error.message);
            });
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    });
</script>
{{ end }}
