{{ define "main" }}
<section class="container mx-auto py-10">
    <h2 class="text-2xl font-bold mb-4">Signaler un point noir</h2>
    <p>Cliquer sur la carte afin de pointer le lieu du point de signalement.</p>

    <button id="locate" class="bg-blue-500 text-white px-4 py-2 rounded mt-2 mb-2">Utiliser ma localisation</button>
    
    <section>
        <div id="map_signalement" class="mt-4 rounded border min-h-[350px]"></div>
    </section>

    <form class="mt-4" id="signaler" method="POST">
        <label for="name" class="block font-semibold">Nom :</label>
        <label for="fileInput">Choisir une photo :</label>
        <input type="file" id="fileInput" name="photo" accept="image/png, image/jpeg" required />
        
        <input type="text" id="name" name="name" class="w-full border p-2 rounded mb-2 form-input" required>

        <label for="email" class="block font-semibold">Email :</label>
        <input type="email" id="email" name="email" class="w-full border p-2 rounded mb-2 form-input" required>
        <label for="message" class="block font-semibold">Description :</label>
        <textarea
            id="message"
            name="message"
            class="form-input"
            placeholder="Description de la situation..."
            rows="8">
        </textarea>
        <input type="hidden" id="coords" name="coords" class="w-full border p-2 rounded mb-2" readonly required>
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded">Envoyer</button>
    </form>
</section>

<script>
document.getElementById("signaler").addEventListener("submit", async function(event) {
    event.preventDefault();
    
    let fileInput = document.getElementById("fileInput").files[0];
    let reader = new FileReader();
    reader.readAsDataURL(fileInput);
    
    reader.onload = async function() {
        let base64File = reader.result.split(',')[1];
        
        let data = {
            file: base64File,
            fileType: fileInput.type,
            fileName: fileInput.name,
            name: document.getElementById("name").value,
            email: document.getElementById("email").value,
            latitude: document.getElementById("coords").value,
            longitude: document.getElementById("longitude").value
        };
        
        // Envoi des données à Google Apps Script
        let response = await fetch("https://white-truth-2869.ivan-zupancic.workers.dev", {
            method: "POST",
            body: JSON.stringify(data),
            headers: { "Content-Type": "application/json" }
        });
        
        let result = await response.json();      
    };
});
</script>
{{ end }}
